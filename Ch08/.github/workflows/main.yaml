# This workflow was generated by pipeline-composer
# Auto-generated - do not edit manually
# Regenerate with: python pipeline-composer.py --config pipeline-config.yaml

name: myapp CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - src/**
      - tests/**
      - Dockerfile
      - requirements.txt
  pull_request:
    branches:
      - main
      - develop

env:
  REGISTRY: ghcr.io/platformetrics
  IMAGE_NAME: myapp

jobs:
  build:
    uses: ./.github/workflows/reusable/build-and-test.yaml
    name: Build and Test
    with:
      language: python
      language-version: latest
      artifact-name: myapp-build
  security:
    uses: ./.github/workflows/reusable/security-scan.yaml
    name: Security Scan
    needs: ["build"]
    with:
      scan-container: true
      scan-dependencies: true
      fail-on-critical: true
  deploy-staging:
    uses: ./.github/workflows/reusable/deploy.yaml
    name: Deploy to Staging
    needs: ["security"]
    with:
      environment: staging
      deployment-strategy: blue-green
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
      namespace: staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  notify:
    runs-on: ubuntu-latest
    name: Notify Pipeline Status
    needs: ["build", "security"]
    if: always()
    steps:
      - name: Pipeline Status
        run: echo "Pipeline completed with status: ${{ job.status }}"