# Backstage Helm Chart Values — Local Kind Cluster
# Chart repo: https://backstage.github.io/charts
# Docs: https://github.com/backstage/charts
#
# The default Backstage image (ghcr.io/backstage/backstage:latest) ships with
# a built-in app-config.yaml that already includes:
#   - auth.environment: development  (guest auth enabled)
#   - auth.providers.guest: {}       (guest sign-in resolver)
#   - integrations.github with token: ${GITHUB_TOKEN}
#   - backend.database: better-sqlite3 :memory:
#
# This values file overrides only what we need for a Kind deployment:
#   1. Switch the database from SQLite to PostgreSQL (Bitnami subchart)
#   2. Inject GITHUB_TOKEN from a Kubernetes Secret
#   3. Set the base URLs to localhost:7007
#
# IMPORTANT — Two common gotchas with the vanilla Backstage Helm deployment:
#
#   Gotcha 1: "Failed to load entity kinds" / 401 Unauthorized on Catalog page
#     The built-in image ships with auth.environment: development and guest
#     auth enabled, so this works out of the box. If you override the auth
#     section in appConfig and forget to include guest, you'll get 401 on
#     every /api/* call. We intentionally preserve the built-in auth config
#     by NOT overriding the auth section here.
#
#   Gotcha 2: "Missing credentials" when registering a GitHub catalog URL
#     The built-in image has integrations.github configured to read
#     ${GITHUB_TOKEN} from the environment. The token must actually be
#     present in the container. We use extraEnvVarsSecrets to inject it
#     from a Kubernetes Secret called 'backstage-secrets'. The secret key
#     name (GITHUB_TOKEN) must match the env var name exactly.
#     Create it with:
#       kubectl create secret generic backstage-secrets \
#         --namespace backstage \
#         --from-literal=GITHUB_TOKEN=ghp_YourTokenHere

# --- Backstage application ---
backstage:
  replicas: 1

  image:
    registry: ghcr.io
    repository: backstage/backstage
    tag: "latest"
    pullPolicy: IfNotPresent

  containerPorts:
    backend: 7007

  # Inject GITHUB_TOKEN from Kubernetes Secret into the container.
  # The built-in app-config.yaml reads ${GITHUB_TOKEN} for GitHub integration.
  # extraEnvVarsSecrets injects every key from the named secret as an env var.
  extraEnvVarsSecrets:
    - backstage-secrets

  # Override only the settings that differ from the built-in app-config.yaml.
  # The Helm chart merges this with the image's default config.
  # We do NOT override the auth section — the built-in guest auth works as-is.
  appConfig:
    app:
      title: "Platform Engineer's Handbook — Developer Portal"
      baseUrl: http://localhost:7007
    backend:
      baseUrl: http://localhost:7007
      listen:
        port: 7007
      database:
        client: pg
        connection:
          host: backstage-postgresql
          port: 5432
          user: backstage
          password: backstage
      cache:
        store: memory

  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# --- Kubernetes Service ---
service:
  type: ClusterIP
  ports:
    backend: 7007

# --- Ingress (disabled — use port-forward for Kind) ---
ingress:
  enabled: false

# --- PostgreSQL (Bitnami subchart) ---
# Provides persistent catalog storage instead of the default SQLite :memory:
postgresql:
  enabled: true
  auth:
    username: backstage
    password: backstage
    database: backstage
  primary:
    persistence:
      enabled: false    # No default StorageClass in Kind

# --- Service Account ---
serviceAccount:
  create: true
  name: backstage
