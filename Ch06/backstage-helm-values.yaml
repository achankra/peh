# Backstage Helm Chart Values — Local Kind Cluster
# Chart repo: https://backstage.github.io/charts
# Docs: https://github.com/backstage/charts
#
# Prerequisites:
#   1. Create a GitHub Personal Access Token (classic) with 'repo' scope:
#      https://github.com/settings/tokens/new
#   2. Export it: export GITHUB_TOKEN=ghp_YourTokenHere
#   3. Create the Kubernetes secret:
#      kubectl create namespace backstage
#      kubectl create secret generic backstage-secrets \
#        --namespace backstage --from-literal=GITHUB_TOKEN=$GITHUB_TOKEN
#
# How config loading works:
#   The default Backstage Docker image ships with a built-in app-config.yaml
#   that includes guest auth and GitHub integration (reading ${GITHUB_TOKEN}).
#   By default, the Helm chart ONLY loads its generated ConfigMap, skipping
#   the built-in config. We use 'args' to load both:
#     1. /app/app-config.yaml           ← built-in defaults (auth, integrations)
#     2. /app/app-config-from-configmap.yaml ← our overrides (DB, URLs, etc.)
#   Later files override earlier ones, so our database/URL settings win.
#
# What this values file configures:
#   - Loads built-in config (guest auth + GitHub integration) via args
#   - PostgreSQL database (persistent catalog storage via Bitnami subchart)
#   - Base URLs for localhost:7007 (Kind port-forward, no ingress)
#   - Disables default auth policy (required for guest auth API access)
#
# Common errors if misconfigured:
#   "401 Unauthorized" on Catalog page → auth section missing or wrong
#   "Missing credentials" on Register page → GITHUB_TOKEN not in container

# --- Backstage application ---
backstage:
  replicas: 1

  image:
    registry: ghcr.io
    repository: backstage/backstage
    tag: "latest"
    pullPolicy: IfNotPresent

  containerPorts:
    backend: 7007

  # Load the built-in app-config.yaml FIRST (provides guest auth, GitHub
  # integration defaults), then layer our ConfigMap overrides on top.
  # Without this, the Helm chart only loads the ConfigMap and skips the
  # built-in config, which causes "401 Unauthorized" / "Missing credentials".
  args:
    - "--config"
    - "/app/app-config.yaml"
    - "--config"
    - "/app/app-config-from-configmap.yaml"

  # Inject GITHUB_TOKEN from Kubernetes Secret into the container.
  # The built-in app-config.yaml reads ${GITHUB_TOKEN} for GitHub integration.
  # extraEnvVarsSecrets injects every key from the named secret as an env var.
  extraEnvVarsSecrets:
    - backstage-secrets

  appConfig:
    app:
      title: "Platform Engineer's Handbook — Developer Portal"
      baseUrl: http://localhost:7007

    backend:
      baseUrl: http://localhost:7007
      listen:
        port: 7007
      database:
        client: pg
        connection:
          host: backstage-postgresql
          port: 5432
          user: backstage
          password: backstage
      cache:
        store: memory
      # Allow unauthenticated access to API — required for guest auth to work
      auth:
        dangerouslyDisableDefaultAuthPolicy: true

    # Guest auth — allows using the portal without login.
    # Required for local Kind demos. In production, use OAuth/OIDC (Chapter 3).
    auth:
      environment: development
      providers:
        guest: {}

    # Allow all entity kinds to be registered via URL (default blocks User, Group, etc.)
    catalog:
      rules:
        - allow:
            - Component
            - API
            - System
            - Domain
            - Group
            - Resource
            - Template
            - Location
            - User

    # GitHub integration — lets Backstage fetch catalog-info.yaml from GitHub.
    # ${GITHUB_TOKEN} is resolved from the container env var at startup.
    integrations:
      github:
        - host: github.com
          token: ${GITHUB_TOKEN}

  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# --- Kubernetes Service ---
service:
  type: ClusterIP
  ports:
    backend: 7007

# --- Ingress (disabled — use port-forward for Kind) ---
ingress:
  enabled: false

# --- PostgreSQL (Bitnami subchart) ---
# Provides persistent catalog storage instead of the default SQLite :memory:
postgresql:
  enabled: true
  auth:
    username: backstage
    password: backstage
    database: backstage
  primary:
    persistence:
      enabled: false    # No default StorageClass in Kind

# --- Service Account ---
serviceAccount:
  create: true
  name: backstage
