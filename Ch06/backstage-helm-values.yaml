# Backstage Helm Chart Values
# This configuration deploys Backstage on a local Kind cluster for demo purposes.
# Adapted for the official backstage/backstage Helm chart (v2.x).
#
# Chart repo: https://backstage.github.io/charts
# Docs: https://github.com/backstage/charts

# --- Backstage application ---
backstage:
  replicas: 1

  image:
    registry: ghcr.io
    repository: backstage/backstage
    tag: "latest"
    pullPolicy: IfNotPresent

  containerPorts:
    backend: 7007

  # Extra environment variables passed to the Backstage container
  extraEnvVars:
    - name: NODE_ENV
      value: production
    - name: LOG_LEVEL
      value: info
    - name: GITHUB_TOKEN
      valueFrom:
        secretKeyRef:
          name: backstage-github-token
          key: token

  # Inline app-config overrides (merged with the image's built-in app-config.yaml)
  appConfig:
    app:
      title: "Backstage Developer Portal"
      baseUrl: http://localhost:7007
    backend:
      baseUrl: http://localhost:7007
      listen:
        port: 7007
      database:
        client: pg
        connection:
          host: backstage-postgresql
          port: 5432
          user: backstage
          password: ChangeMe123!
          database: backstage
      cache:
        store: memory
    # Auth — enable guest access for local demo (no SSO/Keycloak in Kind)
    # In production, replace with OAuth/OIDC provider (see app-config.production.yaml)
    auth:
      environment: development
      providers:
        guest:
          dangerouslyAllowOutsideDevelopment: true
    # GitHub integration — required for catalog registration from GitHub URLs
    # Replace YOUR_GITHUB_TOKEN with a Personal Access Token (classic)
    # with 'repo' scope: https://github.com/settings/tokens/new
    integrations:
      github:
        - host: github.com
          token: ${GITHUB_TOKEN}

  # Resource requests and limits
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# --- Kubernetes Service ---
service:
  type: ClusterIP
  ports:
    backend: 7007

# --- Ingress (disabled for local Kind cluster) ---
ingress:
  enabled: false

# --- PostgreSQL (Bitnami subchart) ---
postgresql:
  enabled: true
  auth:
    username: backstage
    password: ChangeMe123!
    database: backstage
  primary:
    persistence:
      enabled: false          # Disable PVC for Kind (no default StorageClass)

# --- Service Account ---
serviceAccount:
  create: true
  name: backstage
