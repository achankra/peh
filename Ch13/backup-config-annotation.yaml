apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-app
  namespace: default
  labels:
    app: demo-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: demo-app
  
  template:
    metadata:
      labels:
        app: demo-app
      
      # Velero backup hooks annotations
      annotations:
        # Pre-backup hook: quiesce database operations
        pre.hook.backup.velero.io/container: database-sidecar
        pre.hook.backup.velero.io/command: '["/bin/sh", "-c", "echo \"Preparing database for backup...\" && db-quiesce --wait=true && echo \"Database prepared\""]'
        pre.hook.backup.velero.io/on-error: Fail
        pre.hook.backup.velero.io/exec-timeout: "5m"
        
        # Post-backup hook: resume database operations
        post.hook.backup.velero.io/container: database-sidecar
        post.hook.backup.velero.io/command: '["/bin/sh", "-c", "echo \"Resuming database operations...\" && db-resume && echo \"Database resumed\""]'
        post.hook.backup.velero.io/on-error: Continue
        post.hook.backup.velero.io/exec-timeout: "2m"
        
        # Additional metadata
        backup.velero.io/backup-volumes: "data-volume"
        backup.velero.io/exclude-volumes: "temp-volume"
    
    spec:
      # Service account for backup operations
      serviceAccountName: demo-app
      
      # Termination grace period for graceful shutdown
      terminationGracePeriodSeconds: 30
      
      containers:
        # Main application container
        - name: app
          image: demo-app:1.0
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
              name: http
          
          env:
            - name: LOG_LEVEL
              value: "info"
            - name: DB_HOST
              value: "localhost"
          
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          
          volumeMounts:
            - name: data-volume
              mountPath: /app/data
            - name: config-volume
              mountPath: /app/config
        
        # Database sidecar container for backup hooks
        - name: database-sidecar
          image: redis:7-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 6379
              name: redis
          
          env:
            - name: REDIS_LOGLEVEL
              value: "notice"
          
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
          
          volumeMounts:
            - name: data-volume
              mountPath: /data
          
          # Startup and readiness probes
          startupProbe:
            exec:
              command:
                - redis-cli
                - ping
            initialDelaySeconds: 5
            periodSeconds: 5
          
          readinessProbe:
            exec:
              command:
                - redis-cli
                - ping
            periodSeconds: 10
      
      # Volume definitions
      volumes:
        # Data volume for persistent storage
        - name: data-volume
          persistentVolumeClaim:
            claimName: demo-app-data
        
        # Temporary volume (excluded from backup)
        - name: temp-volume
          emptyDir: {}
        
        # Configuration volume
        - name: config-volume
          configMap:
            name: demo-app-config
            defaultMode: 0644

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: demo-app-data
  namespace: default
  labels:
    app: demo-app
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 10Gi

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: demo-app-config
  namespace: default
data:
  application.properties: |
    app.name=demo-app
    app.version=1.0
    backup.enabled=true
    backup.schedule=daily

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: demo-app
  namespace: default
